<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Test Data for Assignment Testing</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #1a1a1a; color: white; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; background: #2a2a2a; }
        button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #666; cursor: not-allowed; }
        .log { background: #111; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        input, textarea { padding: 8px; margin: 5px; border: 1px solid #555; border-radius: 4px; background: #333; color: white; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
    <h1>üß™ Create Test Data for Assignment Testing</h1>
    
    <div class="section">
        <h2>üìù Step 1: Create Test Grievance</h2>
        <input type="text" id="grievanceTitle" value="Test Grievance for Assignment Testing" placeholder="Grievance Title">
        <textarea id="grievanceDesc" placeholder="Grievance Description">This is a test grievance created for testing the bid assignment process. It simulates a real infrastructure issue that needs worker bids.</textarea>
        <input type="text" id="grievanceLocation" value="Test City, Test State" placeholder="Location">
        <input type="number" id="grievanceCost" value="500" placeholder="Estimated Cost">
        <button onclick="createTestGrievance()">Create Test Grievance</button>
    </div>

    <div class="section">
        <h2>üí∞ Step 2: Create Test Bids</h2>
        <p>Grievance ID: <span id="createdGrievanceId">Will appear after grievance creation</span></p>
        <input type="number" id="bidAmount1" value="450" placeholder="Bid Amount 1">
        <textarea id="bidProposal1" placeholder="Bid Proposal 1">I can fix this issue efficiently within the estimated timeline. I have experience with similar infrastructure problems.</textarea>
        <input type="number" id="bidHours1" value="48" placeholder="Estimated Hours 1">
        <button onclick="createTestBid(1)" disabled id="bidBtn1">Create Test Bid 1</button>
        
        <br><br>
        
        <input type="number" id="bidAmount2" value="520" placeholder="Bid Amount 2">
        <textarea id="bidProposal2" placeholder="Bid Proposal 2">Alternative approach with premium materials and faster delivery.</textarea>
        <input type="number" id="bidHours2" value="36" placeholder="Estimated Hours 2">
        <button onclick="createTestBid(2)" disabled id="bidBtn2">Create Test Bid 2</button>
    </div>

    <div class="section">
        <h2>üß™ Step 3: Test Assignment</h2>
        <p>After creating test data:</p>
        <ol>
            <li>Go to <a href="http://localhost:8082/dao/bids" target="_blank" style="color: #4CAF50;">DAO Bid Management</a></li>
            <li>Look for "Test Grievance for Assignment Testing"</li>
            <li>Click "Assign Work" on one of the test bids</li>
            <li>Open browser console (F12) to see detailed logs</li>
            <li>Check if MetaMask popup appears</li>
        </ol>
        <button onclick="window.open('http://localhost:8082/dao/bids', '_blank')" style="background: #2196F3;">Open Bid Management</button>
    </div>

    <div class="section">
        <h2>üìä Logs</h2>
        <div id="logs" class="log"></div>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = '';
        let createdGrievanceId = '';

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logs.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // First, we need to authenticate
        async function authenticate() {
            try {
                log('üîê Authenticating as DAO member...', 'info');
                
                // Mock authentication data - replace with real signature if needed
                const authData = {
                    walletAddress: '0xff85a4c7082c12251c80fdf4b7f46ca04e6c43d9',
                    signature: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef12',
                    message: 'Sign this message to authenticate with Zentigrity.\\n\\nWallet: 0xff85a4c7082c12251c80fdf4b7f46ca04e6c43d9\\nUser Type: dao\\nTimestamp: ' + new Date().toISOString(),
                    timestamp: new Date().toISOString(),
                    userType: 'dao'
                };

                const response = await fetch(`${API_BASE}/users/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(authData)
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.data.token;
                    log('‚úÖ Authentication successful', 'success');
                    return true;
                } else {
                    const error = await response.text();
                    log(`‚ùå Authentication failed: ${error}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Authentication error: ${error.message}`, 'error');
                return false;
            }
        }

        async function createTestGrievance() {
            try {
                if (!authToken && !(await authenticate())) {
                    return;
                }

                log('üìù Creating test grievance...', 'info');
                
                const grievanceData = {
                    title: document.getElementById('grievanceTitle').value,
                    description: document.getElementById('grievanceDesc').value,
                    category: 'infrastructure',
                    priority: 'medium',
                    location: document.getElementById('grievanceLocation').value,
                    estimated_cost: parseInt(document.getElementById('grievanceCost').value),
                    evidence: ['test-evidence.jpg'],
                    address: {
                        street: '123 Test Street',
                        city: 'Test City',
                        state: 'Test State',
                        pincode: '123456'
                    }
                };

                const response = await fetch(`${API_BASE}/grievances`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(grievanceData)
                });

                if (response.ok) {
                    const data = await response.json();
                    createdGrievanceId = data.data._id;
                    document.getElementById('createdGrievanceId').textContent = createdGrievanceId;
                    
                    // Enable bid creation buttons
                    document.getElementById('bidBtn1').disabled = false;
                    document.getElementById('bidBtn2').disabled = false;
                    
                    log(`‚úÖ Test grievance created successfully: ${createdGrievanceId}`, 'success');
                } else {
                    const error = await response.text();
                    log(`‚ùå Failed to create grievance: ${error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error creating grievance: ${error.message}`, 'error');
            }
        }

        async function createTestBid(bidNumber) {
            try {
                if (!createdGrievanceId) {
                    log('‚ùå Please create a grievance first', 'error');
                    return;
                }

                log(`üí∞ Creating test bid ${bidNumber}...`, 'info');
                
                const bidData = {
                    grievance_id: createdGrievanceId,
                    bid_amount: parseInt(document.getElementById(`bidAmount${bidNumber}`).value),
                    proposal: document.getElementById(`bidProposal${bidNumber}`).value,
                    estimated_completion_time: parseInt(document.getElementById(`bidHours${bidNumber}`).value),
                    skills_offered: ['Road Repair', 'Infrastructure', 'Quality Assurance']
                };

                const response = await fetch(`${API_BASE}/worker-bids`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(bidData)
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Test bid ${bidNumber} created successfully: ${data.data._id}`, 'success');
                    log(`üí∞ Bid Amount: ‚Çπ${bidData.bid_amount}, Hours: ${bidData.estimated_completion_time}`, 'info');
                } else {
                    const error = await response.text();
                    log(`‚ùå Failed to create bid ${bidNumber}: ${error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error creating bid ${bidNumber}: ${error.message}`, 'error');
            }
        }

        // Auto-authenticate on page load
        window.onload = function() {
            log('üöÄ Test Data Creator Ready', 'success');
            log('üìã Instructions:', 'info');
            log('1. Click "Create Test Grievance"', 'info');
            log('2. Click "Create Test Bid 1" and "Create Test Bid 2"', 'info');
            log('3. Go to DAO Bid Management to test assignment', 'info');
        };
    </script>
</body>
</html>